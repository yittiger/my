<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>excel.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-$ui_utils_events-Events.html">Events</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_events-Events.html#$emit">$emit</a></li><li data-type='method'><a href="module-$ui_utils_events-Events.html#$off">$off</a></li><li data-type='method'><a href="module-$ui_utils_events-Events.html#$on">$on</a></li><li data-type='method'><a href="module-$ui_utils_events-Events.html#$once">$once</a></li><li data-type='method'><a href="module-$ui_utils_events-Events.html#destroy">destroy</a></li><li data-type='method'><a href="module-$ui_utils_events-Events.html#off">off</a></li><li data-type='method'><a href="module-$ui_utils_events-Events.html#on">on</a></li></ul></li><li><a href="module-$ui_utils_messager.html">$ui/utils/messager</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_messager.html#bridgeHandler">bridgeHandler</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#buildBridge">buildBridge</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#destroy">destroy</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#off">off</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#pass">pass</a></li></ul></li><li><a href="module-$ui_utils_queue-Queue.html">Queue</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_queue-Queue.html#clear">clear</a></li><li data-type='method'><a href="module-$ui_utils_queue-Queue.html#destroy">destroy</a></li><li data-type='method'><a href="module-$ui_utils_queue-Queue.html#push">push</a></li><li data-type='method'><a href="module-$ui_utils_queue-Queue.html#run">run</a></li><li data-type='method'><a href="module-$ui_utils_queue-Queue.html#start">start</a></li><li data-type='method'><a href="module-$ui_utils_queue-Queue.html#stop">stop</a></li></ul></li><li><a href="module-$ui_utils_socket.html">$ui/utils/socket</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_socket.html#close">close</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#connect">connect</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#destroy">destroy</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#getState">getState</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#reconnect">reconnect</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#send">send</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-$ui_utils_ajax.html">$ui/utils/ajax</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_ajax.html#.transformHandler">transformHandler</a></li></ul></li><li><a href="module-$ui_utils_axios.html">$ui/utils/axios</a></li><li><a href="module-$ui_utils_bom.html">$ui/utils/bom</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_bom.html#.exitFullScreen">exitFullScreen</a></li><li data-type='method'><a href="module-$ui_utils_bom.html#.fullScreen">fullScreen</a></li><li data-type='method'><a href="module-$ui_utils_bom.html#.isFullScreen">isFullScreen</a></li></ul></li><li><a href="module-$ui_utils_bridge.html">$ui/utils/bridge</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_bridge.html#.fire">fire</a></li><li data-type='method'><a href="module-$ui_utils_bridge.html#.on">on</a></li><li data-type='method'><a href="module-$ui_utils_bridge.html#.once">once</a></li><li data-type='method'><a href="module-$ui_utils_bridge.html#.provider">provider</a></li><li data-type='method'><a href="module-$ui_utils_bridge.html#.service">service</a></li></ul></li><li><a href="module-$ui_utils_bus.html">$ui/utils/bus</a></li><li><a href="module-$ui_utils_color.html">$ui/utils/color</a></li><li><a href="module-$ui_utils_cookie.html">$ui/utils/cookie</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_cookie.html#.get">get</a></li><li data-type='method'><a href="module-$ui_utils_cookie.html#.has">has</a></li><li data-type='method'><a href="module-$ui_utils_cookie.html#.keys">keys</a></li><li data-type='method'><a href="module-$ui_utils_cookie.html#.remove">remove</a></li><li data-type='method'><a href="module-$ui_utils_cookie.html#.set">set</a></li></ul></li><li><a href="module-$ui_utils_crypto.html">$ui/utils/crypto</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_crypto.html#.base64Decode">base64Decode</a></li><li data-type='method'><a href="module-$ui_utils_crypto.html#.base64Encode">base64Encode</a></li><li data-type='method'><a href="module-$ui_utils_crypto.html#.decryptByDES">decryptByDES</a></li><li data-type='method'><a href="module-$ui_utils_crypto.html#.encryptByDES">encryptByDES</a></li><li data-type='method'><a href="module-$ui_utils_crypto.html#.md5">md5</a></li></ul></li><li><a href="module-$ui_utils_date.html">$ui/utils/date</a></li><li><a href="module-$ui_utils_dictionary.html">$ui/utils/dictionary</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_dictionary.html#.arrayToMap">arrayToMap</a></li><li data-type='method'><a href="module-$ui_utils_dictionary.html#.keysToMap">keysToMap</a></li><li data-type='method'><a href="module-$ui_utils_dictionary.html#.mapToArray">mapToArray</a></li><li data-type='method'><a href="module-$ui_utils_dictionary.html#.mapToKeys">mapToKeys</a></li></ul></li><li><a href="module-$ui_utils_dom.html">$ui/utils/dom</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_dom.html#.insertAfter">insertAfter</a></li><li data-type='method'><a href="module-$ui_utils_dom.html#.isHidden">isHidden</a></li><li data-type='method'><a href="module-$ui_utils_dom.html#.scrollTop">scrollTop</a></li></ul></li><li><a href="module-$ui_utils_download.html">$ui/utils/download</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_download.html#.download">download</a></li><li data-type='method'><a href="module-$ui_utils_download.html#.downloadBlob">downloadBlob</a></li><li data-type='method'><a href="module-$ui_utils_download.html#.downloadByData">downloadByData</a></li><li data-type='method'><a href="module-$ui_utils_download.html#.downloadByPost">downloadByPost</a></li><li data-type='method'><a href="module-$ui_utils_download.html#.stringToBlob">stringToBlob</a></li></ul></li><li><a href="module-$ui_utils_events.html">$ui/utils/events</a></li><li><a href="module-$ui_utils_excel.html">$ui/utils/excel</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_excel.html#.reader">reader</a></li><li data-type='method'><a href="module-$ui_utils_excel.html#~complexTableExport">complexTableExport</a></li></ul></li><li><a href="module-$ui_utils_helper.html">$ui/utils/helper</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_helper.html#.install">install</a></li></ul></li><li><a href="module-$ui_utils_log.html">$ui/utils/log</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_log.html#.create">create</a></li><li data-type='method'><a href="module-$ui_utils_log.html#.dir">dir</a></li><li data-type='method'><a href="module-$ui_utils_log.html#.error">error</a></li><li data-type='method'><a href="module-$ui_utils_log.html#.info">info</a></li><li data-type='method'><a href="module-$ui_utils_log.html#.log">log</a></li><li data-type='method'><a href="module-$ui_utils_log.html#.tip">tip</a></li><li data-type='method'><a href="module-$ui_utils_log.html#.warn">warn</a></li></ul></li><li><a href="module-$ui_utils_lunar.html">$ui/utils/lunar</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_lunar.html#.getFestivals">getFestivals</a></li></ul></li><li><a href="module-$ui_utils_messager.html">$ui/utils/messager</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_messager.html#bridgeHandler">bridgeHandler</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#buildBridge">buildBridge</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#destroy">destroy</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#off">off</a></li><li data-type='method'><a href="module-$ui_utils_messager.html#pass">pass</a></li></ul></li><li><a href="module-$ui_utils_mock.html">$ui/utils/mock</a></li><li><a href="module-$ui_utils_money.html">$ui/utils/money</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_money.html#.format">format</a></li><li data-type='method'><a href="module-$ui_utils_money.html#.reverse">reverse</a></li></ul></li><li><a href="module-$ui_utils_queue.html">$ui/utils/queue</a></li><li><a href="module-$ui_utils_regex.html">$ui/utils/regex</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_regex.html#.isEmail">isEmail</a></li><li data-type='method'><a href="module-$ui_utils_regex.html#.isId">isId</a></li><li data-type='method'><a href="module-$ui_utils_regex.html#.isMobilePhone">isMobilePhone</a></li><li data-type='method'><a href="module-$ui_utils_regex.html#.isUrl">isUrl</a></li></ul></li><li><a href="module-$ui_utils_responsive.html">$ui/utils/responsive</a></li><li><a href="module-$ui_utils_skin.html">$ui/utils/skin</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_skin.html#.change">change</a></li><li data-type='method'><a href="module-$ui_utils_skin.html#.get">get</a></li></ul></li><li><a href="module-$ui_utils_socket.html">$ui/utils/socket</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_socket.html#close">close</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#connect">connect</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#destroy">destroy</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#getState">getState</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#reconnect">reconnect</a></li><li data-type='method'><a href="module-$ui_utils_socket.html#send">send</a></li></ul></li><li><a href="module-$ui_utils_storage.html">$ui/utils/storage</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_storage.html#.clear">clear</a></li><li data-type='method'><a href="module-$ui_utils_storage.html#.get">get</a></li><li data-type='method'><a href="module-$ui_utils_storage.html#.remove">remove</a></li><li data-type='method'><a href="module-$ui_utils_storage.html#.save">save</a></li></ul></li><li><a href="module-$ui_utils_tree.html">$ui/utils/tree</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_tree.html#.create">create</a></li><li data-type='method'><a href="module-$ui_utils_tree.html#.find">find</a></li><li data-type='method'><a href="module-$ui_utils_tree.html#.findPath">findPath</a></li></ul></li><li></li><li><a href="module-$ui_utils_tween.html">$ui/utils/tween</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInBack">easeInBack</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInBounce">easeInBounce</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInCirc">easeInCirc</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInCubic">easeInCubic</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInElastic">easeInElastic</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInExpo">easeInExpo</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutBack">easeInOutBack</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutBounce">easeInOutBounce</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutCubic">easeInOutCubic</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutQuad">easeInOutQuad</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutQuart">easeInOutQuart</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutQuint">easeInOutQuint</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInOutSine">easeInOutSine</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInQuad">easeInQuad</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInQuart">easeInQuart</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInQuint">easeInQuint</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeInSine">easeInSine</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutBack">easeOutBack</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutBounce">easeOutBounce</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutCirc">easeOutCirc</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutCubic">easeOutCubic</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutElastic">easeOutElastic</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutExpo">easeOutExpo</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutQuad">easeOutQuad</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutQuart">easeOutQuart</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutQuint">easeOutQuint</a></li><li data-type='method'><a href="module-$ui_utils_tween.html#.easeOutSine">easeOutSine</a></li></ul></li><li><a href="module-$ui_utils_url.html">$ui/utils/url</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_url.html#.appendQuery">appendQuery</a></li><li data-type='method'><a href="module-$ui_utils_url.html#.getHost">getHost</a></li><li data-type='method'><a href="module-$ui_utils_url.html#.getParams">getParams</a></li><li data-type='method'><a href="module-$ui_utils_url.html#.parse">parse</a></li><li data-type='method'><a href="module-$ui_utils_url.html#.stringify">stringify</a></li></ul></li><li><a href="module-$ui_utils_util.html">$ui/utils/util</a><ul class='methods'><li data-type='method'><a href="module-$ui_utils_util.html#.cancelAnimationFrame">cancelAnimationFrame</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.cloneDeep">cloneDeep</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.debounce">debounce</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.get">get</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.grouping">grouping</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.guid">guid</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.isEqual">isEqual</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.pager">pager</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.requestAnimationFrame">requestAnimationFrame</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.set">set</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.throttle">throttle</a></li><li data-type='method'><a href="module-$ui_utils_util.html#.uid">uid</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="module-$ui_utils_socket.html#~event:close">close</a></li><li><a href="module-$ui_utils_socket.html#~event:error">error</a></li><li><a href="module-$ui_utils_socket.html#~event:message">message</a></li><li><a href="module-$ui_utils_socket.html#~event:open">open</a></li><li><a href="module-utils_queue-Queue.html#event:complete">complete</a></li><li><a href="module-utils_queue-Queue.html#event:error">error</a></li><li><a href="module-utils_queue-Queue.html#event:success">success</a></li></ul><h3>Global</h3><ul><li><a href="global.html#isFlexSupported">isFlexSupported</a></li><li><a href="global.html#isStyleSupport">isStyleSupport</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">excel.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Excel 文件读写模块
 * @module $ui/utils/excel
 */

import XLSX from 'xlsx';

function setAutoWidth(ws, data) {
  /* set worksheet max width per col */
  const colWidth = data.map(row => row.map(val => {
    /* if null/undefined */
    if (val === null) {
      return {wch: 10};
      /* if chinese */
    } else if (val.toString().charCodeAt(0) > 255) {
      return {wch: val.toString().length * 2};
    } else {
      return {wch: val.toString().length};
    }
  }))
  /* start in the first row */
  const result = colWidth[0];
  for (let i = 1; i &lt; colWidth.length; i++) {
    for (let j = 0; j &lt; colWidth[i].length; j++) {
      if (result[j].wch &lt; colWidth[i][j].wch) {
        result[j].wch = colWidth[i][j].wch;
      }
    }
  }
  ws['!cols'] = result;
}

function jsonToArray(key, jsonData) {
  return jsonData.map(v => key.map(j => {
    return v[j]
  }));
}

// fix data,return string
function fixData(data) {
  let o = ''
  let l = 0
  const w = 10240
  for (; l &lt; data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)))
  o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)))
  return o
}


// get head from excel file,return array
function getHeaderRow(sheet) {
  const headers = []
  const range = XLSX.utils.decode_range(sheet['!ref'])
  let C
  const R = range.s.r
  /* start in the first row */
  for (C = range.s.c; C &lt;= range.e.c; ++C) { /* walk every column in the range */
    const cell = sheet[XLSX.utils.encode_cell({c: C, r: R})]
    /* find the cell in the first row */
    let hdr = 'UNKNOWN ' + C // &lt;-- replace with your desired default
    if (cell &amp;&amp; cell.t) hdr = XLSX.utils.format_cell(cell)
    headers.push(hdr)
  }
  return headers
}

/**
 * 导出文件
 * @param {array} key 列标识数组
 * @param {array} title 列文本数组
 * @param {array} data 行数据
 * @param {string} fileName 导出文件名，不含扩展名
 * @param {boolean} autoWidth 是否设置自动列宽度
 * @return {Promise&lt;any>}
 */
export const write = ({key, data, title, fileName, autoWidth}) => {
  return new Promise(resolve => {
    const wb = XLSX.utils.book_new();
    const arr = jsonToArray(key, data);
    arr.unshift(title);
    const ws = XLSX.utils.aoa_to_sheet(arr);
    if (autoWidth) {
      setAutoWidth(ws, arr);
    }
    XLSX.utils.book_append_sheet(wb, ws, fileName);
    XLSX.writeFile(wb, fileName + '.xlsx');
    resolve()
  })
}

// 获取table的行数据
function addTableRow(obj, arr) {
  Array.prototype.forEach.call(obj.rows, r => {
    const row = [];
    Array.prototype.forEach.call(r.cells, c => {
      row.push(c.innerText + '\x0a')
    })
    arr.push(row)
  })
  return arr;
}

// 判断是el-table的表格还是 table标签，并获取行数据
function getTableData(table) {
  if(!table) {
    throw new Error('表格类型错误')
  }
  let arr = [];
  const headerEl = table.querySelector('.el-table__header');
  const bodyEl = table.querySelector('.el-table__body');
  if(headerEl &amp;&amp; bodyEl) {
    arr = addTableRow(headerEl, arr)
    arr = addTableRow(bodyEl, arr)
  } else if(table instanceof HTMLElement &amp;&amp; table.tagName === 'TABLE') {
    arr = addTableRow(table, arr)
  } else {
    throw new Error('表格类型错误')
  }
  return arr;
}

/**
 *
 * @param {Array|Object} tables 表格数组或者对象， 必须是table标签或者el-table的 $el
 * @param {Array|String} sheetNames 表名数组或字符串
 * @param {String} fileName 文件名
 * @param {autoWidth} autoWidth = true
 */
export const writeFromTable = ({tables, sheetNames, fileName, autoWidth = true}) => {
  return new Promise((resolve) => {
    const wb = XLSX.utils.book_new();
    // 可以传数组（生成多表excel文件)或对象（单表excel文件)
    if(tables instanceof Array &amp;&amp; sheetNames instanceof Array) {
      tables.forEach((table, idx) => {
        const arr = getTableData(table);
        const ws = XLSX.utils.aoa_to_sheet(arr)
        if(autoWidth) {
          setAutoWidth(ws, arr)
        }
        XLSX.utils.book_append_sheet(wb, ws, sheetNames[idx])
      })
    } else {
      const arr = getTableData(tables);
      const ws = XLSX.utils.aoa_to_sheet(arr)
      if(autoWidth) {
        setAutoWidth(ws, arr)
      }
      XLSX.utils.book_append_sheet(wb, ws, sheetNames)
    }
    XLSX.writeFile(wb, fileName + '.xlsx');
    resolve()
  })
}
/**
 * 文件转换成JSON数据
 * @param {Object|String} data 文件流
 * @param {String} type 数据类型 array 或 base64
 * @return {{header: Array, results: any[] | * | any[][]}}
 */
export const read = (data, type) => {
  /* if type == 'base64' must fix data first */
  let workbook
  if (type === 'base64') {
    const fixedData = fixData(data)
    workbook = XLSX.read(btoa(fixedData), {type: 'base64'})
  } else {
    workbook = XLSX.read(data, {type: type});
  }
  const firstSheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[firstSheetName];
  const header = getHeaderRow(worksheet);
  const results = XLSX.utils.sheet_to_json(worksheet);
  return {header, results};
}

/**
 * 读取文件
 * @param {Object} file 文件框响应的文件对象
 * @param {object} options 参数选项，可侦听回调函数，如：onloadstart / onprogress / onerror / onload
 * @return {Promise&lt;any>}
 */
export function reader(file, options = {}) {
  const reader = new FileReader()
  reader.readAsArrayBuffer(file)
  return new Promise((resolve, reject) => {
    const opt = {
      ...options,
      onerror(e) {
        options.onerror &amp;&amp; options.onerror(e)
        reject(e)
      },
      onload(e) {
        const reuslt = e.target.result
        options.onload &amp;&amp; options.onload(reuslt)
        resolve(reuslt)
      }
    }
    Object.keys(opt).forEach(key => {
      reader[key] = opt[key]
    })
  })
  
}

// ============== 以下为复杂表头输出函数集合 =============================
const getHeader = function(headers, excelHeader, deep, perOffset) {
  let offset = 0;
  let cur = excelHeader[deep];
  if (!cur) {
    cur = excelHeader[deep] = [];
  }
  pushUndefined(cur, perOffset - cur.length);
  for (let i = 0; i &lt; headers.length; i++) {
    const head = headers[i];
    cur.push(head.name);
    // head.hasOwnProperty('child')
    if (head.child &amp;&amp; Array.isArray(head.child) &amp;&amp; head.child.length > 0) {
      const childOffset = getHeader(
        head.child,
        excelHeader,
        deep + 1,
        cur.length - 1
      );
      pushNull(cur, childOffset - 1);
      offset += childOffset;
    } else {
      offset++;
    }
  }
  return offset;
};
const pushUndefined = function(arr, count) {
  for (let i = 0; i &lt; count; i++) {
    arr.push(undefined);
  }
};
const pushNull = function(arr, count) {
  for (let i = 0; i &lt; count; i++) {
    arr.push(null);
  }
};
const fillNull = function(arr) {
  const max = Math.max(...arr.map(a => a.length));
  arr.filter(e => e.length &lt; max).forEach(e => pushNull(e, max - e.length));
};
const extractData = function(selectionData, revealList) {
  const headerList = [];
  flat(revealList, headerList);
  // 结果集
  const result = [];
  selectionData.forEach(row => {
    const rowData = [];
    headerList.forEach(prop => {
      let value = null;
      if (typeof prop === 'function') {
        value = prop(row);
      } else {
        value = row[prop];
      }
      value = value === null || value === undefined ? '' : value;
      rowData.push(value);
    });
    result.push(rowData);
  });
  return result;
};
const flat = function(revealList, result) {
  revealList.forEach(e => {
    if (e.child) {
      flat(e.child, result);
    } else if (e.exeFun) {
      result.push(e.exeFun);
    } else if (e.prop) {
      result.push(e.prop);
    }
  });
};
const doMerges = function(arr) {
  // 要么横向合并 要么纵向合并
  const deep = arr.length;
  const merges = [];
  for (let y = 0; y &lt; deep; y++) {
    // 先处理横向合并
    const row = arr[y];
    let colSpan = 0;
    for (let x = 0; x &lt; row.length; x++) {
      if (row[x] === null) {
        colSpan++;
        if (x + 1 === row.length &amp;&amp; (colSpan > 0 &amp;&amp; x > colSpan)) {
          merges.push({ s: { r: y, c: x - colSpan }, e: { r: y, c: x } });
        }
      } else if (colSpan > 0 &amp;&amp; x > colSpan) {
        merges.push({ s: { r: y, c: x - colSpan - 1 }, e: { r: y, c: x - 1 } });
        colSpan = 0;
      } else {
        colSpan = 0;
      }
    }
  }
  // 再处理纵向合并
  const colLength = arr[0].length;
  for (let x = 0; x &lt; colLength; x++) {
    let rowSpan = 0;
    for (let y = 0; y &lt; deep; y++) {
      if (arr[y][x] != null) {
        rowSpan = 0;
      } else {
        rowSpan++;
      }
    }
    if (rowSpan > 0) {
      merges.push({
        s: { r: deep - rowSpan - 1, c: x },
        e: { r: deep - 1, c: x }
      });
    }
  }
  return merges;
};
const aoaToSheet = function(data) {
  const ws = {};
  const range = { s: { c: 10000000, r: 10000000 }, e: { c: 0, r: 0 } };
  for (let R = 0; R !== data.length; ++R) {
    for (let C = 0; C !== data[R].length; ++C) {
      if (range.s.r > R) range.s.r = R;
      if (range.s.c > C) range.s.c = C;
      if (range.e.r &lt; R) range.e.r = R;
      if (range.e.c &lt; C) range.e.c = C;
      /// 这里生成cell的时候，使用上面定义的默认样式
      const cell = {
        v: data[R][C],
        s: {
          font: { name: '宋体', sz: 11, color: { auto: 1 } },
          border: {
            color: { auto: 1 }
          },
          alignment: {
            /// 自动换行
            wrapText: 1,
            // 居中
            horizontal: 'center',
            vertical: 'center',
            indent: 0
          }
        }
      };
      if (cell.v == null) continue;
      const cellRef = XLSX.utils.encode_cell({ c: C, r: R });
      if (typeof cell.v === 'number') cell.t = 'n';
      else if (typeof cell.v === 'boolean') cell.t = 'b';
      // 类型处理
      // else if (cell.v instanceof Date) {
      //   cell.t = 'n'; cell.z = XLSX.SSF._table[14];
      //   cell.v = this.dateNum(cell.v);
      // }
      else cell.t = 's';
      ws[cellRef] = cell;
    }
  }
  if (range.s.c &lt; 10000000) ws['!ref'] = XLSX.utils.encode_range(range);
  return ws;
};
const s2ab = function(s) {
  const buf = new ArrayBuffer(s.length);
  const view = new Uint8Array(buf);
  for (let i = 0; i !== s.length; ++i) view[i] = s.charCodeAt(i) &amp; 0xff;
  return buf;
};
const openDownloadXLSXDialog = function(url, saveName) {
  if (typeof url === 'object' &amp;&amp; url instanceof Blob) {
    url = URL.createObjectURL(url); // 创建blob地址
  }
  const aLink = document.createElement('a');
  aLink.href = url;
  aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
  let event;
  if (window.MouseEvent) event = new MouseEvent('click');
  else {
    event = document.createEvent('MouseEvents');
    event.initMouseEvent(
      'click',
      true,
      false,
      window,
      0,
      0,
      0,
      0,
      0,
      false,
      false,
      false,
      false,
      0,
      null
    );
  }
  aLink.dispatchEvent(event);
};

/**
 * 读取文件
 * @param {String} docName 输出文件名称
 * @param {Array} rowData 行数据
 * @param {Array} colData 表头列数据 {name: '表头名', prop: '字段名', child: []}
 * cloData = [ { name: '姓名', prop: 'name' }, { name: '专业技能', child: [ { name: '前端', child: [ { name: 'JavaScript', prop: 'js' } ] } ] } ]
 */
const complexTableExport = function(docName, rowData, colData) {
  const sheetName = docName; // '多级表头excel'
  const excelHeader = []; // [[], []]; // , [] 
  getHeader(colData, excelHeader, 0, 0);
  fillNull(excelHeader);
  const merges = doMerges(excelHeader);
  const dataList = extractData(rowData, colData);
  excelHeader.push(...dataList);
  const ws = aoaToSheet(excelHeader);
  ws['!merges'] = merges;
  const workbook = {
    SheetNames: [sheetName],
    Sheets: {}
  };
  workbook.Sheets[sheetName] = ws;
  // excel样式
  const wopts = {
    bookType: 'xlsx',
    bookSST: true,
    type: 'binary',
    cellStyles: true
  };
  const wbout = XLSX.write(workbook, wopts);
  const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
  openDownloadXLSXDialog(blob, sheetName + '.xlsx');
}; 

// ===========================================


export default { write, writeFromTable, read, reader, complexTableExport }
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Wed May 19 2021 18:10:18 GMT+0800 (GMT+08:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>




<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c4e5f73318b5cb0c389e3d9a05f831cc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>
</html>
